- name: setting server name for {{ component }}
  ansible.builtin.shell: set-hostname "{{ component }}"
- name: Install nodejs >= 20
  ansible.builtin.package:
    name: nodejs=20
    state: present
- name: create user expense
  ansible.builtin.user:
    name: expense
- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: /app
    state: directory
- name: Download backend code from git repo and storing in temp
  ansible.builtin.get_url:
    url: https://expense-web-app.s3.amazonaws.com/{{ component }}.zip
    dest: /tmp/{{ component }}.zip
- name: Extract {{ component }}.zip into html 
  ansible.builtin.unarchive:
    src: /tmp/{{ component }}.zip
    dest: /app
    remote_src: yes

- name: Install {{ component }} node.js package.
  community.general.npm:
    name: "{{ component }}"
    path: /app
- name: Change file ownership, group and permissions
  ansible.builtin.file:
    path: /app
    state: directory
    recurse: yes
    owner: expense
    group: expense
    mode: '0755'
- name: installing {{component }} server
  ansible.builtin.package:
    name: mysql-server
    state: present
- name: installing dependecies for mysql
  ansible.builtin.yum:
    name: python3-PyMySQL
    state: present
- name: injecting schema
  mysql_db:
   name: all
   state: import
   target: /app/schema/backend.sql
   login_user: root
   login_password: ExpenseApp@1
   login_host: 172.31.38.21

- name: Start and enable service "{{ component }}"
  ansible.builtin.systemd_service:
    name: "{{ component }}"
    state: restarted
    daemon_reload: true
    enabled: yes
